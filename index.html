<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pemasukan Pengeluaran</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom Scrollbar for Desktop Only */
        @media (min-width: 768px) {
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 20px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col items-center bg-gray-100">

    <!-- App Container -->
    <div class="w-full md:max-w-6xl min-h-screen md:min-h-0 md:h-[90vh] bg-white md:shadow-2xl flex flex-col md:flex-row relative md:mt-8 md:rounded-3xl md:overflow-hidden border-gray-200 pb-28 md:pb-0">
        
        <!-- Left Panel (Header & Dashboard) -->
        <div class="bg-indigo-700 text-white p-6 pb-12 md:pb-6 rounded-b-[2.5rem] md:rounded-b-none md:rounded-l-3xl shadow-md z-10 shrink-0 md:w-5/12 lg:w-1/3 md:h-full md:flex md:flex-col md:justify-center md:items-center relative transition-all duration-300 md:overflow-y-auto">
            
            <div class="w-full max-w-xs mx-auto text-center md:text-left pt-2 md:pt-0">
                <div class="flex justify-between items-center mb-6 md:mb-6">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fas fa-store-alt"></i> Perc. Alfajar
                    </h2>
                    <!-- Export Button (Visible on Mobile & Desktop) -->
                    <button onclick="openExportModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-bold py-2 px-3 rounded-lg shadow-lg transition-colors flex items-center gap-2">
                        <i class="fas fa-file-export"></i> Ekspor
                    </button>
                </div>
                
                <!-- Main Balance & Breakdown Section -->
                <div class="bg-indigo-800/50 rounded-2xl p-5 mb-6 backdrop-blur-sm border border-indigo-500/30 shadow-lg">
                    <div class="text-center mb-4 border-b border-indigo-500/30 pb-4">
                        <p class="text-indigo-200 text-xs mb-1 uppercase tracking-wider">Total</p>
                        <h1 id="balance" class="text-3xl font-bold tracking-tight">Rp 0</h1>
                    </div>
                    
                    <!-- Split Balances -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Cash Balance -->
                        <div class="bg-indigo-600/40 p-3 rounded-xl border border-indigo-500/30 flex flex-col items-center hover:bg-indigo-600/60 transition-colors">
                            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center mb-2 text-indigo-200">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <p class="text-[10px] text-indigo-200 uppercase font-bold">Kas Tunai</p>
                            <p id="balance-cash" class="text-sm font-bold text-white truncate w-full text-center">Rp 0</p>
                        </div>
                        <!-- Transfer Balance -->
                        <div class="bg-blue-600/40 p-3 rounded-xl border border-blue-500/30 flex flex-col items-center hover:bg-blue-600/60 transition-colors">
                            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center mb-2 text-blue-200">
                                <i class="fas fa-university"></i>
                            </div>
                            <p class="text-[10px] text-blue-200 uppercase font-bold">Transfer</p>
                            <p id="balance-transfer" class="text-sm font-bold text-white truncate w-full text-center">Rp 0</p>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards Grid (Flow) -->
                <div class="grid grid-cols-2 gap-3 bg-white/5 p-4 rounded-2xl backdrop-blur-sm border border-white/10">
                    <div class="text-left">
                        <h4 class="text-xs text-indigo-200 uppercase font-bold mb-1">Pemasukan</h4>
                        <p id="money-plus" class="text-green-300 text-sm font-bold truncate">+Rp 0</p>
                    </div>
                    <div class="text-left">
                        <h4 class="text-xs text-indigo-200 uppercase font-bold mb-1">Pengeluaran</h4>
                        <p id="money-minus" class="text-red-300 text-sm font-bold truncate">-Rp 0</p>
                    </div>
                    <div class="col-span-2 mt-2 pt-2 border-t border-indigo-500/30 flex justify-between items-center group cursor-pointer hover:bg-white/5 rounded-lg px-2 -mx-2 transition-all">
                        <div class="text-left">
                            <h4 class="text-xs text-indigo-200 uppercase font-bold mb-1">Sisa (Belum Lunas)</h4>
                            <p id="receivable" class="text-yellow-300 text-lg font-bold truncate">Rp 0</p>
                        </div>
                        <div class="h-10 w-10 rounded-full bg-yellow-500/20 flex items-center justify-center group-hover:bg-yellow-500/30 transition-colors">
                            <i class="fas fa-file-invoice-dollar text-yellow-300 text-lg"></i>
                        </div>
                    </div>
                </div>

                <!-- Desktop Add Button -->
                <button onclick="openModal()" class="hidden md:flex w-full bg-white text-indigo-700 py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-50 transition-all active:scale-95 justify-center items-center gap-2 mt-6">
                    <i class="fas fa-plus-circle text-lg"></i>
                    Catat Transaksi Baru
                </button>
            </div>
        </div>

        <!-- Right Panel (Transaction History) -->
        <div class="flex-1 md:overflow-y-auto pt-10 px-4 md:pb-6 scroll-smooth md:w-7/12 lg:w-2/3 md:pt-8 md:px-8 bg-gray-50/50 h-auto">
            
            <div class="max-w-4xl mx-auto">
                <h3 class="border-b-2 border-gray-200 pb-3 font-bold text-gray-700 mb-4 flex justify-between items-center text-lg sticky top-0 md:relative bg-gray-50/95 md:bg-transparent backdrop-blur-sm z-30 py-2">
                    Riwayat Transaksi
                    <button onclick="clearAll()" class="text-xs text-red-500 hover:text-red-700 font-medium px-3 py-1 rounded-full hover:bg-red-50 transition-colors" id="clear-btn" style="display: none;">
                        <i class="fas fa-trash-alt mr-1"></i> Reset
                    </button>
                </h3>
                
                <ul id="list" class="space-y-3 pb-24 md:pb-4">
                    <!-- Javascript will inject list items here -->
                    <li id="empty-state" class="text-center text-gray-400 py-12 flex flex-col items-center justify-center h-full">
                        <div class="bg-white p-6 rounded-full mb-4 shadow-sm">
                            <i class="fas fa-cash-register text-4xl text-gray-300"></i>
                        </div>
                        <p class="text-base font-medium text-gray-500">Belum ada catatan.</p>
                        <p class="text-sm mt-1">Catat pesanan atau pengeluaran pertama Anda.</p>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Mobile Floating Button -->
        <div class="fixed bottom-0 left-0 w-full bg-gradient-to-t from-white via-white to-transparent pt-6 pb-6 px-4 z-40 md:hidden">
            <button id="toggle-form-btn" onclick="openModal()" class="w-full bg-indigo-700 text-white py-4 rounded-xl font-semibold shadow-xl hover:bg-indigo-800 transition-all active:scale-95 flex justify-center items-center gap-2 border border-indigo-600">
                <i class="fas fa-plus-circle text-lg"></i> Catat Transaksi
            </button>
        </div>

        <!-- Add/Edit Form Overlay -->
        <div id="form-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden flex justify-center items-end md:items-center p-0 md:p-4">
            <div class="bg-white w-full max-w-md p-6 rounded-t-3xl md:rounded-3xl shadow-2xl transform transition-transform duration-300 translate-y-full flex flex-col max-h-[90vh] overflow-y-auto" id="form-panel">
                <div class="flex justify-between items-center mb-6 shrink-0">
                    <h3 class="text-xl font-bold text-gray-800" id="form-title">Catat Transaksi</h3>
                    <button id="close-form-btn" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 w-8 h-8 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <form id="form" class="space-y-4">
                    <!-- Transaction Type Toggle -->
                    <div class="grid grid-cols-2 gap-3 p-1 bg-gray-100 rounded-xl">
                        <label class="cursor-pointer">
                            <input type="radio" name="type" value="income" class="peer sr-only" checked onchange="updateFormLabels()">
                            <div class="py-2.5 text-center rounded-lg text-gray-500 font-semibold transition-all peer-checked:bg-white peer-checked:text-green-600 peer-checked:shadow-sm">
                                <i class="fas fa-arrow-down mr-1"></i> Pemasukan
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="type" value="expense" class="peer sr-only" onchange="updateFormLabels()">
                            <div class="py-2.5 text-center rounded-lg text-gray-500 font-semibold transition-all peer-checked:bg-white peer-checked:text-red-600 peer-checked:shadow-sm">
                                <i class="fas fa-arrow-up mr-1"></i> Pengeluaran
                            </div>
                        </label>
                    </div>

                    <div>
                        <label for="text" class="block text-xs font-bold text-gray-500 uppercase mb-2">Nama Barang / Jasa <span class="text-red-500">*</span></label>
                        <input type="text" id="text" placeholder="Contoh: Cetak Spanduk..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all" required />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="total-price" class="block text-xs font-bold text-gray-500 uppercase mb-2">Total Harga</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-semibold text-sm">Rp</span>
                                <input type="number" id="total-price" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-10 pr-3 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all font-semibold" oninput="calculateRemaining()" />
                            </div>
                        </div>
                        <div>
                            <label for="paid-amount" id="paid-label" class="block text-xs font-bold text-gray-500 uppercase mb-2">Dibayar (DP)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-semibold text-sm">Rp</span>
                                <input type="number" id="paid-amount" placeholder="0" class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-10 pr-3 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all font-semibold text-green-600" oninput="calculateRemaining()" />
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Metode Pembayaran</label>
                        <div class="flex gap-3">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="method" value="cash" class="peer sr-only" checked>
                                <div class="py-2.5 px-3 text-center border border-gray-200 rounded-xl text-gray-500 text-sm font-medium peer-checked:bg-indigo-50 peer-checked:border-indigo-500 peer-checked:text-indigo-700 transition-all flex items-center justify-center gap-2 hover:bg-gray-50">
                                    <i class="fas fa-wallet"></i> Tunai
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="method" value="transfer" class="peer sr-only">
                                <div class="py-2.5 px-3 text-center border border-gray-200 rounded-xl text-gray-500 text-sm font-medium peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 transition-all flex items-center justify-center gap-2 hover:bg-gray-50">
                                    <i class="fas fa-university"></i> Transfer
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Remaining Balance Info in Form -->
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 flex justify-between items-center" id="remaining-box">
                        <span class="text-sm text-yellow-800 font-medium">Sisa Tagihan (Piutang):</span>
                        <span id="form-remaining" class="font-bold text-yellow-700">Rp 0</span>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full bg-indigo-700 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-800 mt-2 active:scale-95 transition-all flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Simpan Transaksi
                    </button>
                </form>
            </div>
        </div>

        <!-- Detail View Overlay -->
        <div id="detail-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden flex justify-center items-end md:items-center p-0 md:p-4">
            <div class="bg-white w-full max-w-sm p-6 rounded-t-3xl md:rounded-3xl shadow-2xl transform transition-transform duration-300 translate-y-full" id="detail-panel">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 md:hidden"></div>

                <div class="text-center mb-6">
                    <div id="detail-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm">
                        <i id="detail-icon" class="fas"></i>
                    </div>
                    <h3 id="detail-title" class="text-xl font-bold text-gray-800 mb-1 break-words">Nama Transaksi</h3>
                    <p id="detail-date" class="text-sm text-gray-400">12/12/2025 14.30</p>
                </div>

                <div class="bg-gray-50 rounded-2xl p-4 space-y-3 mb-6 border border-gray-100">
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                        <span class="text-sm text-gray-500">Total Nominal</span>
                        <span id="detail-total" class="font-semibold text-gray-800">Rp 0</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                        <span class="text-sm text-gray-500">Status</span>
                        <span id="detail-status" class="text-sm font-bold px-2 py-0.5 rounded-md bg-gray-200">Lunas</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                        <span class="text-sm text-gray-500">Metode</span>
                        <span id="detail-method" class="font-medium text-gray-800 flex items-center gap-1"><i class="fas fa-wallet"></i> Tunai</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500" id="detail-paid-label">Diterima</span>
                        <span id="detail-paid" class="font-bold text-indigo-600">Rp 0</span>
                    </div>
                    <div class="flex justify-between items-center pt-1" id="detail-remaining-row">
                        <span class="text-sm text-gray-500">Sisa / Piutang</span>
                        <span id="detail-remaining" class="font-bold text-yellow-600">Rp 0</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="detail-edit-btn" class="py-3 rounded-xl bg-indigo-50 text-indigo-600 font-semibold hover:bg-indigo-100 transition-colors flex justify-center items-center gap-2">
                        <i class="fas fa-pen"></i> Edit
                    </button>
                    <button id="detail-close-btn" class="py-3 rounded-xl bg-gray-100 text-gray-600 font-semibold hover:bg-gray-200 transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        </div>

        <!-- Export Modal (NEW) -->
        <div id="export-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[90] hidden flex justify-center items-center p-4">
            <div class="bg-white w-full max-w-sm p-6 rounded-3xl shadow-2xl transform transition-all scale-95 opacity-0" id="export-panel">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Ekspor Laporan</h3>
                    <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="fas fa-times"></i></button>
                </div>
                
                <p class="text-sm text-gray-500 mb-4">Pilih jenis laporan yang ingin disimpan.</p>

                <!-- Filter Option -->
                <div class="bg-gray-50 p-1 rounded-lg flex mb-6">
                    <button id="export-today" onclick="setExportFilter('today')" class="flex-1 py-2 text-sm font-semibold rounded-md shadow-sm bg-white text-indigo-600 transition-all">Hari Ini</button>
                    <button id="export-all" onclick="setExportFilter('all')" class="flex-1 py-2 text-sm font-semibold rounded-md text-gray-500 hover:text-gray-700 transition-all">Semua</button>
                </div>

                <div class="space-y-3">
                    <button onclick="exportToCSV()" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold flex items-center justify-center gap-3 transition-colors">
                        <i class="fas fa-file-excel text-lg"></i> Download CSV (Excel)
                    </button>
                    <button onclick="copyToClipboard()" class="w-full py-3 px-4 bg-gray-800 hover:bg-gray-900 text-white rounded-xl font-semibold flex items-center justify-center gap-3 transition-colors">
                        <i class="fab fa-whatsapp text-lg text-green-400"></i> Salin Teks (WhatsApp)
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Toast with Fade Transition -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-4 rounded-xl shadow-2xl transition-opacity duration-200 z-[99] flex items-center gap-4 border-l-4 border-indigo-400 opacity-0 pointer-events-none">
        <!-- Content injected by JS -->
    </div>

    <script>
        // DOM Elements
        const balance = document.getElementById('balance');
        const balanceCash = document.getElementById('balance-cash');
        const balanceTransfer = document.getElementById('balance-transfer');
        const money_plus = document.getElementById('money-plus');
        const money_minus = document.getElementById('money-minus');
        const receivable = document.getElementById('receivable');
        const list = document.getElementById('list');
        const form = document.getElementById('form');
        const text = document.getElementById('text');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        
        // Inputs
        const totalPriceInput = document.getElementById('total-price');
        const paidAmountInput = document.getElementById('paid-amount');
        const formRemainingDisplay = document.getElementById('form-remaining');
        
        const emptyState = document.getElementById('empty-state');
        const clearBtn = document.getElementById('clear-btn');
        const toast = document.getElementById('toast');

        // Modal Elements
        const toggleFormBtn = document.getElementById('toggle-form-btn');
        const closeFormBtn = document.getElementById('close-form-btn');
        const formOverlay = document.getElementById('form-overlay');
        const formPanel = document.getElementById('form-panel');

        // Detail Modal Elements
        const detailOverlay = document.getElementById('detail-overlay');
        const detailPanel = document.getElementById('detail-panel');
        const detailCloseBtn = document.getElementById('detail-close-btn');
        const detailEditBtn = document.getElementById('detail-edit-btn');

        // Export Modal Elements
        const exportOverlay = document.getElementById('export-overlay');
        const exportPanel = document.getElementById('export-panel');
        let exportFilter = 'today'; // 'today' or 'all'

        // Data Storage
        const localStorageTransactions = JSON.parse(localStorage.getItem('transactions'));
        let transactions = localStorage.getItem('transactions') !== null ? localStorageTransactions : [];
        let editingId = null; 

        // Helper: Custom Date Format
        function getFormattedDate() {
            const d = new Date();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = String(d.getFullYear()).slice(-2); 
            return `${day}/${month}/${year} ${hours}.${minutes}`;
        }

        function formatRupiah(number) {
            const formattedNumber = new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(number);
            return 'Rp' + formattedNumber;
        }

        // --- CORE FUNCTIONS (Add, Edit, Delete, Update) ---

        function updateFormLabels() {
            const type = document.querySelector('input[name="type"]:checked').value;
            const paidLabel = document.getElementById('paid-label');
            const remainingBox = document.getElementById('remaining-box');
            if (type === 'expense') {
                paidLabel.innerText = "Jumlah Dibayar";
                // Only autofill if adding (not editing) and field is empty
                if(totalPriceInput.value && !editingId && !paidAmountInput.value) paidAmountInput.value = totalPriceInput.value;
                remainingBox.style.display = 'none'; 
            } else {
                paidLabel.innerText = "Diterima / DP";
                remainingBox.style.display = 'flex';
            }
            calculateRemaining();
        }

        function calculateRemaining() {
            const total = +totalPriceInput.value || 0;
            const paid = +paidAmountInput.value || 0;
            const sisa = total - paid;
            formRemainingDisplay.innerText = formatRupiah(sisa < 0 ? 0 : sisa);
        }

        function addTransaction(e) {
            e.preventDefault();
            
            // Validate ONLY name
            if (text.value.trim() === '') {
                showToast('Nama Barang/Jasa wajib diisi!', true);
                return;
            }

            const type = document.querySelector('input[name="type"]:checked').value;
            const method = document.querySelector('input[name="method"]:checked').value; 
            
            // Get raw values (default to 0 if empty)
            let paidVal = paidAmountInput.value === '' ? 0 : Number(paidAmountInput.value);
            let totalVal = totalPriceInput.value === '' ? 0 : Number(totalPriceInput.value);
            
            // Smart Logic: If Total is Empty but Paid is filled, assume Total = Paid
            if (totalPriceInput.value === '' && paidAmountInput.value !== '') {
                totalVal = paidVal;
            }

            const remainingVal = totalVal - paidVal;
            let dateValue = getFormattedDate();
            
            if (editingId) {
                 const existingTransaction = transactions.find(t => t.id == editingId);
                 if (existingTransaction) dateValue = existingTransaction.date;
            }

            const transactionData = {
                id: editingId ? Number(editingId) : generateID(),
                text: text.value,
                total: totalVal,
                paid: paidVal,
                remaining: remainingVal,
                type: type,
                method: method,
                date: dateValue,
                rawDate: new Date().toISOString().split('T')[0] 
            };

            if (editingId) {
                const index = transactions.findIndex(t => t.id == editingId);
                if (index !== -1) {
                    transactions[index] = transactionData;
                    showToast('Data berhasil diperbarui!');
                }
            } else {
                transactions.push(transactionData);
                showToast('Transaksi berhasil disimpan!');
            }
            updateValues();
            updateLocalStorage();
            init(); 
            closeModal();
        }

        // Updated: Added event and stopPropagation to prevent bubbling
        function editTransaction(id, event) {
            if(event) event.stopPropagation();
            
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            editingId = id;
            text.value = transaction.text;
            totalPriceInput.value = transaction.total;
            paidAmountInput.value = transaction.paid;
            calculateRemaining(); 
            document.querySelector(`input[name="type"][value="${transaction.type}"]`).checked = true;
            document.querySelector(`input[name="method"][value="${transaction.method}"]`).checked = true;
            formTitle.innerText = "Edit Transaksi";
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Transaksi';
            updateFormLabels();
            closeDetail();
            toggleMenu(id);
            openModal();
        }

        function generateID() {
            return Math.floor(Math.random() * 100000000);
        }

        // --- VIEW FUNCTIONS (List, Detail) ---

        function addTransactionDOM(transaction) {
            if (emptyState) emptyState.style.display = 'none';
            const isExpense = transaction.type === 'expense';
            const isLunas = transaction.remaining <= 0;
            const isTransfer = transaction.method === 'transfer';
            let borderClass = isExpense ? 'border-red-500' : (isLunas ? 'border-green-500' : 'border-yellow-400');
            let textAmountClass = isExpense ? 'text-red-500' : 'text-green-600';
            let methodIcon = isTransfer ? 'fa-university' : 'fa-wallet';
            let remainingText = '';
            if (transaction.remaining > 0 && !isExpense) {
                remainingText = `<div class="text-[10px] font-bold text-yellow-600 mt-0.5 bg-yellow-50 inline-block px-1.5 rounded border border-yellow-200">Sisa: ${formatRupiah(transaction.remaining)}</div>`;
            }
            const item = document.createElement('li');
            
            // REMOVED onclick="openDetail(...)", removed cursor-pointer and active:scale classes
            item.className = `bg-white p-3 rounded-xl shadow-sm border-l-4 ${borderClass} flex justify-between items-center gap-2 transition-all hover:shadow-md relative`;
            
            item.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden flex-1 pl-1">
                    <div class="min-w-0">
                        <h4 class="font-bold text-gray-800 text-sm truncate leading-tight">${transaction.text}</h4>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[10px] text-gray-400 flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i> ${transaction.date}
                            </span>
                            <span class="text-[10px] text-gray-400 flex items-center gap-1 bg-gray-100 px-1.5 rounded-sm">
                                <i class="fas ${methodIcon} text-[9px]"></i> ${isTransfer ? 'TF' : 'Tunai'}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3 shrink-0">
                    <div class="text-right">
                        <p class="font-bold ${textAmountClass} text-sm whitespace-nowrap">
                            ${isExpense ? '-' : '+'}${formatRupiah(transaction.paid)}
                        </p>
                        ${remainingText}
                    </div>
                    <div class="relative">
                        <button onclick="toggleMenu(${transaction.id}, event)" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400 transition-colors focus:outline-none">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div id="menu-${transaction.id}" class="hidden absolute right-0 mt-1 w-32 bg-white rounded-lg shadow-lg border border-gray-100 z-20 overflow-hidden origin-top-right transform transition-all">
                            <!-- New Detail Button (Closes menu then opens detail) -->
                            <button onclick="toggleMenu(${transaction.id}, event); openDetail(${transaction.id})" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition-colors border-b border-gray-50">
                                <i class="fas fa-info-circle text-xs text-blue-500 w-4"></i> Detail
                            </button>
                            <button onclick="editTransaction(${transaction.id}, event)" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition-colors border-b border-gray-50">
                                <i class="fas fa-pen text-xs text-indigo-500 w-4"></i> Edit
                            </button>
                            <button onclick="removeTransaction(${transaction.id}, event)" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors">
                                <i class="fas fa-trash-alt text-xs w-4"></i> Hapus
                            </button>
                        </div>
                    </div>
                </div>
            `;
            list.prepend(item);
        }

        function toggleMenu(id, event) {
            if(event) event.stopPropagation(); 
            const allMenus = document.querySelectorAll('[id^="menu-"]');
            allMenus.forEach(menu => { if(menu.id !== `menu-${id}`) menu.classList.add('hidden'); });
            const menu = document.getElementById(`menu-${id}`);
            if (menu) menu.classList.toggle('hidden');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.fa-ellipsis-v') && !event.target.closest('button')) {
                const allMenus = document.querySelectorAll('[id^="menu-"]');
                allMenus.forEach(menu => { if (!menu.classList.contains('hidden')) menu.classList.add('hidden'); });
            }
        }

        function updateValues() {
            const cashIn = transactions.filter(t => t.type === 'income' && t.method === 'cash').reduce((acc, t) => acc + Number(t.paid), 0);
            const cashOut = transactions.filter(t => t.type === 'expense' && t.method === 'cash').reduce((acc, t) => acc + Number(t.paid), 0);
            const transferIn = transactions.filter(t => t.type === 'income' && t.method === 'transfer').reduce((acc, t) => acc + Number(t.paid), 0);
            const transferOut = transactions.filter(t => t.type === 'expense' && t.method === 'transfer').reduce((acc, t) => acc + Number(t.paid), 0);
            
            balance.innerText = formatRupiah((cashIn - cashOut) + (transferIn - transferOut));
            balanceCash.innerText = formatRupiah(cashIn - cashOut);
            balanceTransfer.innerText = formatRupiah(transferIn - transferOut);
            
            money_plus.innerText = `+${formatRupiah(transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + Number(t.paid), 0))}`;
            money_minus.innerText = `-${formatRupiah(transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + Number(t.paid), 0))}`;
            receivable.innerText = formatRupiah(transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + Number(t.remaining), 0));

            if (transactions.length > 0) {
                clearBtn.style.display = 'inline-block';
                emptyState.style.display = 'none';
            } else {
                clearBtn.style.display = 'none';
                emptyState.style.display = 'flex';
            }
        }

        // Updated: Added event and stopPropagation
        function removeTransaction(id, event) {
            if(event) event.stopPropagation();

            if(confirm('Hapus data ini?')) {
                transactions = transactions.filter(t => t.id !== id);
                updateLocalStorage();
                init();
                showToast('Data dihapus', true);
            }
            toggleMenu(id);
            closeDetail();
        }

        function clearAll() {
            if(confirm('Yakin reset semua data pembukuan?')) {
                transactions = [];
                updateLocalStorage();
                init();
                showToast('Buku kas di-reset', true);
            }
        }

        // --- EXPORT FUNCTIONS (NEW) ---

        function openExportModal() {
            exportOverlay.classList.remove('hidden');
            setTimeout(() => { 
                exportPanel.classList.remove('scale-95', 'opacity-0');
                exportPanel.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeExportModal() {
            exportPanel.classList.remove('scale-100', 'opacity-100');
            exportPanel.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { exportOverlay.classList.add('hidden'); }, 300);
        }

        function setExportFilter(filter) {
            exportFilter = filter;
            document.getElementById('export-today').className = filter === 'today' ? "flex-1 py-2 text-sm font-semibold rounded-md shadow-sm bg-white text-indigo-600 transition-all" : "flex-1 py-2 text-sm font-semibold rounded-md text-gray-500 hover:text-gray-700 transition-all";
            document.getElementById('export-all').className = filter === 'all' ? "flex-1 py-2 text-sm font-semibold rounded-md shadow-sm bg-white text-indigo-600 transition-all" : "flex-1 py-2 text-sm font-semibold rounded-md text-gray-500 hover:text-gray-700 transition-all";
        }

        function getFilteredTransactions() {
            if (exportFilter === 'all') return transactions;
            
            // Get today's date in various formats matching how we store it or generate it
            const today = new Date();
            const todayISO = today.toISOString().split('T')[0]; // YYYY-MM-DD
            
            // Filter logic: Check rawDate if exists, else parse the display date
            return transactions.filter(t => {
                if (t.rawDate) return t.rawDate === todayISO;
                // Fallback for old data or if rawDate missing: Check if display date contains current year/month/day
                // Simple string check is usually enough for "dd/mm/yy" format
                const dayStr = String(today.getDate()).padStart(2, '0');
                const monthStr = String(today.getMonth() + 1).padStart(2, '0');
                const yearStr = String(today.getFullYear()).slice(-2);
                const dateStr = `${dayStr}/${monthStr}/${yearStr}`;
                return t.date.includes(dateStr);
            });
        }

        function copyToClipboard() {
            const data = getFilteredTransactions();
            if (data.length === 0) { showToast('Tidak ada data untuk diekspor', true); return; }

            let text = `Pemasukan & Pengeluaran${exportFilter === 'today' ? '' : ''}\n`;
            text += `Tanggal: ${new Date().toLocaleDateString('id-ID')}\n${'\u200B'.repeat(4000)}`;
            text += `--------------------------------\n`;

            let totalMasuk = 0;
            let totalKeluar = 0;
            let totalCash = 0;
            let totalTransfer = 0;

            data.forEach((t, index) => {
                const amount = Number(t.paid);
                const nominal = formatRupiah(t.paid);
                const isExp = t.type === 'expense';

                if (isExp) {
                    totalKeluar += amount;
                } else {
                    totalMasuk += amount;
                }

                const signedAmount = isExp ? -amount : amount;

                if (t.method === 'cash') {
                    totalCash += signedAmount;
                } else if (t.method === 'transfer') {
                    totalTransfer += signedAmount;
                }

                text += `${index + 1}. ${t.text} *(${t.method === 'transfer' ? 'Trf' : 'Cash'} ${isExp ? '-' : '+'}${nominal})* `;
                if (t.remaining > 0) text += `Sisa: ${formatRupiah(t.remaining)}`; else text += ``;
                const isLast = index === data.length - 1;
                text += isLast ? '\n' : '\n\n';
            });

            text += `--------------------------------\n`;
            text += `Cash: ${formatRupiah(totalCash)}\n`;
            text += `Transfer: ${formatRupiah(totalTransfer)}\n\n`;
            text += `Total Keseluruhan *${formatRupiah(totalMasuk - totalKeluar)}*\n`;
            text += `- Pemasukan: ${formatRupiah(totalMasuk)}\n`;
            text += `- Pengeluaran: ${formatRupiah(totalKeluar)}`;

            navigator.clipboard.writeText(text).then(() => {
                showToast('Laporan berhasil disalin!');
                closeExportModal();
            }).catch(err => {
                showToast('Gagal menyalin teks', true);
            });
        }

        function exportToCSV() {
            const data = getFilteredTransactions();
            if (data.length === 0) { showToast('Tidak ada data untuk diekspor', true); return; }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Tanggal,Keterangan,Tipe,Metode,Total Tagihan,Uang Masuk/Keluar,Sisa/Piutang\n";

            data.forEach(t => {
                const dateClean = t.date.replace(',', '');
                const textClean = t.text.replace(/,/g, ' '); // remove commas from desc
                const typeClean = t.type === 'expense' ? 'Pengeluaran' : 'Pemasukan';
                const methodClean = t.method === 'transfer' ? 'Transfer' : 'Tunai';
                
                const row = `${dateClean},${textClean},${typeClean},${methodClean},${t.total},${t.paid},${t.remaining}`;
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Laporan_Keuangan_${exportFilter}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('File CSV berhasil didownload!');
            closeExportModal();
        }

        // --- INITIALIZATION ---

        function updateLocalStorage() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function openModal() {
            formOverlay.classList.remove('hidden');
            setTimeout(() => { formPanel.classList.remove('translate-y-full'); }, 10);
        }

        function closeModal() {
            formPanel.classList.add('translate-y-full');
            setTimeout(() => { formOverlay.classList.add('hidden'); }, 300);
            setTimeout(() => {
                editingId = null;
                form.reset();
                formTitle.innerText = "Catat Transaksi";
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Transaksi';
                document.querySelector('input[value="income"]').checked = true;
                document.querySelector('input[value="cash"]').checked = true;
                formRemainingDisplay.innerText = "Rp 0";
                document.getElementById('remaining-box').style.display = 'flex';
                document.getElementById('paid-label').innerText = "Diterima / DP";
                updateFormLabels();
            }, 300);
        }

        // --- Detail Modal Logic ---
        function openDetail(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;
            const isExpense = transaction.type === 'expense';
            const isLunas = transaction.remaining <= 0;
            const isTransfer = transaction.method === 'transfer';

            document.getElementById('detail-title').innerText = transaction.text;
            document.getElementById('detail-date').innerText = transaction.date;
            
            const iconContainer = document.getElementById('detail-icon-container');
            const icon = document.getElementById('detail-icon');
            
            if(isExpense) {
                iconContainer.className = "w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm bg-red-100 text-red-500";
                icon.className = "fas fa-arrow-up";
                document.getElementById('detail-paid-label').innerText = "Dibayar";
                document.getElementById('detail-remaining-row').style.display = 'none';
            } else {
                iconContainer.className = "w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl shadow-sm bg-green-100 text-green-500";
                icon.className = "fas fa-arrow-down";
                document.getElementById('detail-paid-label').innerText = "Diterima";
                document.getElementById('detail-remaining-row').style.display = 'flex';
            }

            document.getElementById('detail-total').innerText = formatRupiah(transaction.total);
            document.getElementById('detail-paid').innerText = formatRupiah(transaction.paid);
            document.getElementById('detail-remaining').innerText = formatRupiah(transaction.remaining);
            
            const statusBadge = document.getElementById('detail-status');
            if(isExpense) {
                statusBadge.className = "text-sm font-bold px-2 py-0.5 rounded-md bg-red-100 text-red-600";
                statusBadge.innerText = "Pengeluaran";
            } else {
                if(isLunas) {
                    statusBadge.className = "text-sm font-bold px-2 py-0.5 rounded-md bg-green-100 text-green-600";
                    statusBadge.innerText = "Lunas";
                } else {
                    statusBadge.className = "text-sm font-bold px-2 py-0.5 rounded-md bg-yellow-100 text-yellow-700";
                    statusBadge.innerText = "Belum Lunas";
                }
            }
            const methodEl = document.getElementById('detail-method');
            if(isTransfer) {
                methodEl.innerHTML = `<i class="fas fa-university text-blue-500"></i> Transfer`;
            } else {
                methodEl.innerHTML = `<i class="fas fa-wallet text-gray-500"></i> Tunai`;
            }
            // Updated: Added event to edit call (though openDetail -> editTransaction flow is simpler, direct call from menu needed fix)
            detailEditBtn.onclick = () => editTransaction(id); 
            detailOverlay.classList.remove('hidden');
            setTimeout(() => { detailPanel.classList.remove('translate-y-full'); }, 10);
        }

        function closeDetail() {
            detailPanel.classList.add('translate-y-full');
            setTimeout(() => { detailOverlay.classList.add('hidden'); }, 300);
        }

        // Updated Show Toast with Fade transition logic
        function showToast(message, isError = false) {
            const borderClass = isError ? 'border-red-400' : 'border-indigo-400';
            const iconClass = isError ? 'fa-exclamation-circle text-red-400' : 'fa-check-circle text-indigo-400';
            // Reset base classes with opacity-0
            toast.className = `fixed top-5 right-5 bg-gray-800 text-white px-6 py-4 rounded-xl shadow-2xl transition-opacity duration-200 z-[99] flex items-center gap-4 border-l-4 ${borderClass} opacity-0 pointer-events-none`;
            
            toast.innerHTML = `<i class="fas ${iconClass} text-xl"></i><span class="font-medium">${message}</span>`;
            
            // Force reflow
            void toast.offsetWidth;

            // Show
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('opacity-100');

            // Hide after 3s
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        form.addEventListener('submit', addTransaction);
        closeFormBtn.addEventListener('click', closeModal);
        detailCloseBtn.addEventListener('click', closeDetail);
        detailOverlay.addEventListener('click', (e) => { if (e.target === detailOverlay) closeDetail(); });
        formOverlay.addEventListener('click', (e) => { if (e.target === formOverlay) closeModal(); });
        exportOverlay.addEventListener('click', (e) => { if (e.target === exportOverlay) closeExportModal(); });

        function init() {
            list.innerHTML = '';
            list.appendChild(emptyState); 
            transactions.forEach(addTransactionDOM);
            updateValues();
        }

        init();
    </script>
</body>
</html>
